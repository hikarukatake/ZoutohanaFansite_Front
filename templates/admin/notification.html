<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>個別通知送信</title>
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <link rel="stylesheet" href="../../static/css/admin/admin-style.css" th:href="@{/css/admin/admin-style.css}">
</head>

<body id="projectEdit-page">
<div th:replace="~{layout-admin :: header}"></div>

<main id="admin-main">
  <h1 class="page-title">個別通知送信</h1>

  <div class="table-border-b-strong pb-8">
    <div class="main-content-card mt-4 pt-4 pb-4">
      <div class="flex gap-1">
        <span>テンプレート名 : </span>
        <select id="template-select" class="select flex-1 w-full">
          <option value="">テンプレートを選択してください</option>
        </select>
        <button id="load-template-btn" class="btn">呼び出す</button>
      </div>

      <div class="flex gap-1 p-8">
        <span>タイトル : </span>
        <input id="input-title" type="text" class="input-text">
      </div>
      <textarea id="input-content" rows="7" class="input-textarea w-full mt-2"></textarea>

      <div class="flex gap-4 justify-end">
        <p class="text-danger">宛先に間違いがないか再度ご確認ください</p>
        <button type="button" id="confirm-button" class="btn"
                data-modal-target="notification-confirm-modal">確認する</button>
      </div>
    </div>
  </div>

  <div class="mt-8">
    <h2 class="page-title-sub">宛先 : </h2>
    <div>
      <div class="main-content-card p-8 mt-2"> <div class="table-border-b-strong flex justify-between pb-4"> <div> <p class="review-card-sub-info">No.<span>100</span></p>
        <h3 class="review-card-title">小学生の頃から大好きな一冊</h3>
      </div>
      </div>
        <div class="table-border-b-strong flex py-4"> <table class="pr-8 mb-auto"> <tr>
          <th>プロジェクト名 : </th>
          <td>冬に読みたい！わたしのおすすめ文庫</td>
        </tr>
          <tr>
            <th>書評ステータス : </th>
            <td>大賞</td>
          </tr>
          <tr>
            <th>得票数 : </th>
            <td>123</td>
          </tr>
        </table>
          <div class="flex-1"> <table>
            <tr>
              <th>名前 : </th>
              <td>
                <a href="#" th:href="@{/}">
                  <span>なまえなまえ</span>(ID:<span>loginID123</span>)
                </a>
              </td>
            </tr>
            <tr>
              <th>居住地 : </th>
              <td>岩手県盛岡市</td>
            </tr>
            <tr>
              <th>年代 : </th>
              <td><span>20</span>代</td>
            </tr>
            <tr>
              <th>性別 : </th>
              <td>男</td>
            </tr>
          </table>
            <p class="font-bold">自己紹介 : </p>
            <p>この文章はダミーです。文字の大きさ、量、字間、行間等を確認するために入れています。</p>
          </div>
        </div>
        <div class="table-border-b-strong py-4"> <div class="flex">
          <table class="pr-8 mb-auto w-quarter">
            <tr>
              <th>ISBN : </th>
              <td>9784XXXXXXXXXX</td>
            </tr>
            <tr>
              <th>タイトル : </th>
              <td>風の図書館</td>
            </tr>
            <tr>
              <th>出版社 : </th>
              <td>ABC出版</td>
            </tr>
            <tr>
              <th>著者 : </th>
              <td>田中太郎</td>
            </tr>
            <tr>
              <th>形式 : </th>
              <td>文庫</td>
            </tr>
          </table>
          <div class="flex-1">
            <p class="font-bold">本文 : </p>
            <p>この本を初めて読んだのは、小学四年生のときでした。表紙のイラストに惹かれて手に取ったのがきっかけでしたが、読み進めるうちに主人公の冒険や葛藤にどんどん引き込まれていったのを今でも覚えています。
              あの頃は物語の世界に憧れるだけでしたが、大学生になった今読むと、人生の選択や成長の物語として心に響く部分が多く、まるで自分へのメッセージのように感じます。
              文庫版の柔らかい紙の感触や少し黄ばんだページも、懐かしさをより一層引き立ててくれます。何度読み返しても色あせない、僕の原点のような一冊です。</p>
          </div>
        </div>
          <div>
            <p class="mt-4"><span class="font-bold">書評のジャンル : </span>児童書, ファンタジー, 岩手に縁がある作家</p>
          </div>
        </div>
        <div class="flex justify-between pt-4"> <div> <p class="review-card-sub-info">投稿日時 : <span>2025/10/01 12:34</span></p>
          <p class="review-card-sub-info">更新日時 : <span>2025/10/02 23:45</span></p>
        </div>
          <a href="#" th:href="@{/}"
             class="icon-center review-card-sub-info text-decoration-none hover-bold">詳細を確認する<span
                  class="material-symbols-outlined">keyboard_double_arrow_right</span></a> </div>
      </div>
    </div>
  </div>
</main>

<form id="notification-form" th:action="@{/admin/notification/send/{id}(id=${review.id})}" method="post" class="hidden">
  <input type="hidden" name="title" id="hidden-title">
  <input type="hidden" name="content" id="hidden-content">
</form>

<div id="notification-confirm-modal" class="modal">
  <div>
    <div class="modal-content">
      <div class="flex justify-between items-start">
        <h2 class="page-title mx-auto">確認</h2>
        <span class="modal-close"><span class="material-symbols-outlined">close</span></span>
      </div>
      <div class="mt-8">
        <p>以下の内容・宛先で通知を送信してよろしいですか？</p>
      </div>
      <div class="mt-8">
        <h3 class="page-title-sub">タイトル</h3>
        <div class="notification-confirm-preview"><span id="preview-title"></span></div>
      </div>
      <div class="mt-8">
        <h3 class="page-title-sub">内容</h3>
        <p id="notification-content" class="notification-confirm-preview" style="white-space: pre-wrap;"></p>
      </div>
      <div class="mt-8">
        <h3 class="page-title-sub">宛先</h3>
        <p class="notification-confirm-preview">[No.<span>93</span>] <span>冬の魔法をほんの少し信じたくなる</span></p>
      </div>
      <div class="btn-wrap mt-8">
        <button type="button" class="btn" data-modal-close>キャンセル</button>
        <button type="submit" form="notification-form" class="btn">送信する</button>
      </div>
    </div>
  </div>
</div>

<script src="../../static/js/admin/admin-general.js" th:src="@{/js/admin/admin-general.js}"></script>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const templateSelect = document.getElementById('template-select');
    const loadBtn = document.getElementById('load-template-btn');
    const confirmBtn = document.getElementById('confirm-button');

    const inputTitle = document.getElementById('input-title');
    const inputContent = document.getElementById('input-content');

    const previewTitle = document.getElementById('preview-title');
    const previewContent = document.getElementById('notification-content');

    const hiddenTitle = document.getElementById('hidden-title');
    const hiddenContent = document.getElementById('hidden-content');

    // 共通：マージタグ用設定
    const targets = [
      "{project-name}", "{project-submissionStartAt}", "{project-submissionEndAt}",
      "{project-votingStartAt}", "{project-votingEndAt}", "{user-nickname}",
      "{review-title}", "{book-title}"
    ];
    const regex = new RegExp(targets.join('|').replace(/{/g, '\\{').replace(/}/g, '\\}'), 'g');

    // --- 1. テンプレート一覧の取得 ---
    fetch('/api/admin/notification/template/list')
            .then(response => response.json())
            .then(data => {
              data.forEach(template => {
                const option = document.createElement('option');
                option.value = template.id;
                option.textContent = template.title;
                templateSelect.appendChild(option);
              });
            })
            .catch(error => console.error('Error fetching template list:', error));

    // --- 2. テンプレート呼び出し処理 ---
    loadBtn.addEventListener('click', () => {
      const selectedId = templateSelect.value;
      if (!selectedId) {
        alert('テンプレートを選択してください');
        return;
      }

      fetch(`/api/admin/notification/template/${selectedId}`)
              .then(response => response.json())
              .then(data => {
                // 入力フィールドに反映
                inputTitle.value = data.title || '';
                inputContent.value = data.content || '';
              })
              .catch(error => {
                console.error('Error fetching template detail:', error);
                alert('テンプレートの取得に失敗しました');
              });
    });

    // --- 3. モーダル反映ロジック ---
    confirmBtn.addEventListener('click', () => {
      const titleVal = inputTitle.value;
      const contentVal = inputContent.value;

      // プレビュー表示
      previewTitle.textContent = titleVal || '(タイトルなし)';
      previewContent.textContent = contentVal || '(本文なし)';

      // プレビューの特定の文字列を装飾
      const originalText = previewContent.innerHTML;
      previewContent.innerHTML = originalText.replace(regex, (match) => {
        return `<span class="merge-tag-preview">${match}</span>`;
      });

      // 送信用hiddenフォームへの書き込み（タグなしの純粋なテキスト）
      hiddenTitle.value = titleVal;
      hiddenContent.value = contentVal;
    });
  });
</script>
</body>

</html>